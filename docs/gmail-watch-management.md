# ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Gmail Watch ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

## ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Gmail Watch ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏

Gmail Push Notifications ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏∏‡∏Å ~7 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß Gmail ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏á push notifications ‡πÅ‡∏•‡∏∞ server ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà

## ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏•‡πÑ‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô `GmailWatchService` ‡∏ó‡∏µ‡πà‡∏à‡∏∞:

1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ watch** ‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
2. **‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ß‡∏±‡∏ô)
3. **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error** ‡πÄ‡∏°‡∏∑‡πà‡∏≠ watch ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏õ

## ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤

### 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Environment Variables

```bash
# ‡πÉ‡∏ô .env file
GCP_PROJECT_ID=your-gcp-project-id
PUBSUB_TOPIC_NAME=your-topic-name
GMAIL_TOKENS_DIR=secrets/tokens
GMAIL_WATCH_USERS=your-email@gmail.com
```

### 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gmail Watch ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô

```bash
# ‡∏£‡∏±‡∏ô script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ watch ‡πÅ‡∏£‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°
python setup_gmail_watches.py
```

### 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Server

```bash
# Server ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° Gmail Watch Service ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
python app/main.py
```

## ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Server ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

1. **‡πÇ‡∏´‡∏•‡∏î Gmail tokens** ‡∏à‡∏≤‡∏Å `secrets/tokens/`
2. **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ watch** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
3. **‡πÄ‡∏£‡∏¥‡πà‡∏° background thread** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏
4. **‡πÄ‡∏£‡∏¥‡πà‡∏° Pub/Sub listener** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö notifications

### ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å **1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á**
- ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ **1 ‡∏ß‡∏±‡∏ô**
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

### Log Messages ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π

```
‚úÖ Gmail watch setup for user@example.com
üìù Gmail Watch Service started with automatic renewal
üîÑ Renewing Gmail watch for user@example.com
‚úÖ Watch renewed successfully for user@example.com
```

## ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

### 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå State

```bash
ls secrets/tokens/*.state.json
cat secrets/tokens/your-email@gmail.com.state.json
```

### 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log

```bash
# ‡∏î‡∏π log ‡∏Ç‡∏≠‡∏á server
tail -f logs/app.log

# ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ docker logs
docker logs -f secretary_agent_app
```

## ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Watch ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß

**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:** ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
```bash
# 1. ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ watch ‡πÉ‡∏´‡∏°‡πà
docker restart secretary_agent_app

# 2. ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ô script ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
python setup_gmail_watches.py
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Pub/Sub Permission

**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:** Error ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö permission

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
```bash
# ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Gmail push service
gcloud pubsub topics add-iam-policy-binding your-topic-name \
  --member=serviceAccount:gmail-api-push@system.gserviceaccount.com \
  --role=roles/pubsub.publisher \
  --project your-gcp-project-id
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏

**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:** Error ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö OAuth credentials

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
```bash
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OAuth token ‡πÉ‡∏´‡∏°‡πà
python diagnostics/setup_gmail_watch.py \
  --project your-gcp-project-id \
  --topic your-topic-name
```

## ‡∏Å‡∏≤‡∏£ Monitor

### 1. Health Check Endpoint

Server ‡∏°‡∏µ endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:

```bash
curl http://localhost:8080/
```

### 2. Log Monitoring

‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° log messages ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ:

- `Gmail Watch Service started` - Service ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
- `Watch renewed successfully` - ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
- `Failed to renew watch` - ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
- `Gmail push notification received` - ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

## ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á

### ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô `app/main.py`:

```python
# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ
watch_service.start_automatic_renewal(check_interval_hours=0.5)

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á  
watch_service.start_automatic_renewal(check_interval_hours=6)
```

### ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô `service/gmail_watch_service.py`:

```python
# ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 2 ‡∏ß‡∏±‡∏ô
return (expiry_time - current_time) < 2 * 24 * 60 * 60

# ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
return (expiry_time - current_time) < 12 * 60 * 60
```

## ‡∏™‡∏£‡∏∏‡∏õ

‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ server ‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ:

- **‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î** ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á watch ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
- **‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥** ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà watch ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏  
- **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error** ‡πÅ‡∏•‡∏∞ retry ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- **Monitor ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞** ‡∏ú‡πà‡∏≤‡∏ô log messages

‡πÅ‡∏Ñ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ server ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏• Gmail watch ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!